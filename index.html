<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Marathon Coach</title>
    <link rel="icon" type="image/png" sizes="32x32" href="marathon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="marathon (1).png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" href="/site.webmanifest">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body {
      font-family: 'Inter', system-ui, sans-serif;
      /* Adjust padding to the bottom of the body for the floating nav */
      padding-bottom: 8rem; /* Adjusted for floating nav bar */
    }
    /* Custom styling for the file input */
    .file-input-container {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .file-input-label {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      height: 3rem;
      background-color: #f3f4f6; /* bg-gray-100 */
      color: #1f2937; /* text-gray-800 */
      border: 2px dashed #d1d5db; /* border-gray-300 */
      border-radius: 0.75rem; /* rounded-xl */
    }
    .file-input-label:hover {
      background-color: #e5e7eb; /* hover:bg-gray-200 */
    }
    #plan-upload {
      opacity: 0;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    /* Table styles for readability */
    .plan-table th, .plan-table td {
        padding: 0.5rem 0.75rem;
        text-align: left;
        border-bottom: 1px solid #f3f4f6; /* light gray */
        vertical-align: top;
        /* Ensure cells are clickable */
        cursor: pointer; 
    }
    .plan-table th {
        background-color: #f9fafb; /* bg-gray-50 */
        font-weight: 600;
        color: #1f2937; /* text-gray-900 */
    }
    .plan-table tr:hover {
        background-color: #f5f5f5;
    }
    
/* --- Equal button layout (updated for 3 buttons) --- */
#bottom-nav {
  position: fixed;
  bottom: 1.5rem;
  left: 50%;
  transform: translateX(-50%);
  max-width: 420px;
  width: 90%;
  z-index: 50;
  border-radius: 9999px;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
              0 4px 6px -4px rgba(0, 0, 0, 0.05);
}
#bottom-nav > div {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* 3 equal buttons */
  align-items: center;
  width: 100%;
}
.nav-button {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 4.5rem;
  color: #6b7280; /* gray-500 (Default inactive color) */
  border-radius: 9999px;
  /* Add transition for smooth color changes */
  transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out; 
}
.nav-button:hover {
  color: #2563eb;
}
.nav-button.active {
  color: white; /* Override to white when active */
  background-color: #3b82f6;
  border: 2px solid #2563eb;
  box-shadow: 0 0 12px rgba(59, 130, 246, 0.5);
}
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-orange-50 to-white min-h-screen flex flex-col">

  <header class="flex items-center justify-between px-6 py-4 bg-white/70 backdrop-blur-md shadow-md">
    <div class="flex items-center space-x-2">
      <i data-lucide="activity" class="w-6 h-6 text-orange-500"></i>
      <h1 class="text-2xl font-extrabold text-gray-900 tracking-tight">Marathon Coach</h1>
    </div>
  </header>

  <main id="app" class="flex-grow p-6 md:p-10 max-w-3xl mx-auto w-full"></main>

  <nav id="bottom-nav" class="bg-white/90 backdrop-blur shadow-2xl">
    <div class="flex justify-around items-center h-20 max-w-3xl mx-auto">
<button id="nav-wod" onclick="showView('wod', null, this)" class="nav-button flex flex-col items-center p-2 hover:text-blue-600 active">        <i data-lucide="home" class="w-6 h-6"></i>
        <span class="text-xs mt-1">WOD</span>
      </button>
      <button id="nav-plan" onclick="showView('plan', null, this)" class="nav-button flex flex-col items-center p-2 text-gray-500 hover:text-blue-600">
        <i data-lucide="calendar-days" class="w-6 h-6"></i>
        <span class="text-xs mt-1">Plan</span>
      </button>
      <button id="nav-settings" onclick="showView('settings', null, this)" class="nav-button flex flex-col items-center p-2 text-gray-500 hover:text-blue-600">
        <i data-lucide="settings" class="w-6 h-6"></i>
        <span class="text-xs mt-1">Settings</span>
      </button>
    </div>
  </nav>

  <div id="complete-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 w-11/12 max-w-md text-center shadow-xl border border-gray-100">
      <h2 id="complete-modal-title" class="text-xl font-semibold mb-1 text-gray-900"></h2>
      <p id="complete-modal-message" class="text-sm text-gray-500 mb-4"></p>
      
      <form id="complete-form">
          </form>
      
      <button type="button" onclick="closeCompleteModal()"
          class="w-full mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 rounded-xl shadow">
          Close
      </button>
    </div>
  </div>

  <div id="message-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 w-11/12 max-w-md text-center shadow-xl border border-gray-100">
      <h2 id="modal-title" class="text-xl font-semibold mb-3 text-gray-900"></h2>
      <p id="modal-message" class="text-gray-600 mb-4"></p>
      <div id="modal-actions" class="mt-4">
        <button id="modal-close-button" onclick="closeModal()"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-xl shadow">
          Close
        </button>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    // Global App State
    // ---------------------------
    const formatDate = d => new Date(d).toISOString().split('T')[0];
    
    const APP_STATE = {
      plan: JSON.parse(localStorage.getItem('trainingPlan') || '{}'),
      loggedWorkouts: JSON.parse(localStorage.getItem('loggedWorkouts') || '{}'),
      startDate: localStorage.getItem('planStartDate') || null,
      currentWODDate: formatDate(new Date()) // New: Tracks the date shown in WOD view
    };

    // ---------------------------
    // Helpers
    // ---------------------------
    const formatDisplayDate = d => {
        const date = new Date(d);
        const options = { month: 'short', day: 'numeric' };
        return date.toLocaleDateString(undefined, options);
    }
    const DAY_NAMES_SHORT = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    const DAY_NAMES_FULL = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

    // Date utility to add days
    const addDays = (date, days) => {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    };
    
    // Helper to clear the plan
    function clearPlan() {
        if (confirm("Are you sure you want to clear the entire training plan? This cannot be undone.")) {
            APP_STATE.plan = {};
            APP_STATE.startDate = null;
            localStorage.removeItem('trainingPlan');
            localStorage.removeItem('planStartDate');
            showModal('Plan Cleared', 'Your training plan has been removed. Logged completion status remains.');
            // Reset WOD date to today if we were looking at a future/past date
            APP_STATE.currentWODDate = formatDate(new Date()); 
            showView('wod');
        }
    }
    
    // Helper to count plan progress
    function getPlanProgress() {
        const totalWorkouts = Object.keys(APP_STATE.plan).length;
        const completedWorkouts = Object.keys(APP_STATE.loggedWorkouts).filter(date => APP_STATE.loggedWorkouts[date].completed).length;
        
        let startWeek = null;
        let currentWeek = null;
        let totalWeeks = 0;

        const weeks = groupPlanByWeek();
        const weekKeys = Object.keys(weeks);
        
        if (weekKeys.length > 0) {
            totalWeeks = weekKeys.length;
            const todayStr = formatDate(new Date());

            // Simple way to find the current week
            for(let i = 0; i < totalWeeks; i++) {
                const weekKey = weekKeys[i];
                // Check if today is between the start of this week and the start of the next (or end of plan)
                if (weeks[weekKey].startDate <= todayStr) {
                    currentWeek = i + 1;
                } else {
                    break; 
                }
            }
            startWeek = weekKeys[0];
        }


        return { totalWorkouts, completedWorkouts, totalWeeks, currentWeek, startWeek };
    }


function setActiveNav(activeButton) {
    document.querySelectorAll('.nav-button').forEach(btn => {
        // Only remove the 'active' class
        btn.classList.remove('active');
        // Remove the redundant color class manipulation: btn.classList.add('text-gray-500'); 
    });
    if (activeButton) {
        // Only add the 'active' class
        activeButton.classList.add('active');
        // Remove the redundant color class manipulation: activeButton.classList.remove('text-gray-500'); 
    }
}

    /**
     * Renders the specified view immediately.
     * @param {string} view - The view to render ('wod', 'plan', 'complete-wod', 'settings').
     * @param {string} date - The date string for 'complete-wod'.
     * @param {HTMLElement} navButton - The button that was clicked to trigger the view change.
     * @param {string} mode - Optional mode for 'complete-wod' (e.g., 'edit-strava').
     */
    function showView(view, date = null, navButton = null, mode = null) {
      const app = document.getElementById('app');

      if (navButton) setActiveNav(navButton);
      
      // Handle view rendering
      if (view === 'wod') renderWODView(date);
      else if (view === 'plan') renderPlanView();
      else if (view === 'complete-wod' && date) showCompleteModal(date, mode);
      else if (view === 'settings') renderSettingsView();

      // Ensure icons are created after content is loaded
      lucide.createIcons();
    }


    // ---------------------------
    // Modal Helpers (Updated to allow dynamic actions)
    // ---------------------------
    function showModal(title, message, actions = null) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').innerHTML = message;
        
        const actionsDiv = document.getElementById('modal-actions');
        actionsDiv.innerHTML = ''; // Clear default buttons

        if (actions) {
            actions.forEach(action => {
                const button = document.createElement('button');
                button.textContent = action.text;
                button.onclick = action.handler || closeModal;
                button.className = action.className || 'w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-xl shadow';
                
                // Add margins if multiple buttons
                if (actions.length > 1) {
                    button.classList.add('mt-2'); 
                }

                actionsDiv.appendChild(button);
            });
        } else {
            // Default close button
            actionsDiv.innerHTML = `
                <button id="modal-close-button" onclick="closeModal()"
                  class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-xl shadow">
                  Close
                </button>`;
        }
        
        document.getElementById('message-modal').classList.remove('hidden');
        lucide.createIcons();
    }

    function closeModal() {
      document.getElementById('message-modal').classList.add('hidden');
    }
    
    function closeCompleteModal() {
        document.getElementById('complete-modal').classList.add('hidden');
    }
    
    // REGEX for simple Strava link validation
    const stravaRegex = /^(https?:\/\/)?(www\.)?strava\.com\/activities\/\d+$/i;

    /**
     * Handles the form submission for marking a workout complete or saving/updating a Strava link.
     */
    function completeWorkout(dateStr) {
        const stravaLinkInput = document.getElementById('strava-link-input');
        let stravaLink = stravaLinkInput ? stravaLinkInput.value.trim() : (APP_STATE.loggedWorkouts[dateStr]?.strava || '');
        
        // --- Validation for Strava Link ---
        if (stravaLink && !stravaRegex.test(stravaLink)) {
            showModal('Invalid Strava Link', 'Please enter a valid Strava activity URL (e.g., https://www.strava.com/activities/123456789).');
            return; // Stop the function if link is invalid
        }
        
        APP_STATE.loggedWorkouts[dateStr] = {
            completed: true,
            strava: stravaLink,
            date: dateStr,
            plannedActivity: APP_STATE.plan[dateStr]?.activity || 'N/A'
        };

        localStorage.setItem('loggedWorkouts', JSON.stringify(APP_STATE.loggedWorkouts));
        
        closeCompleteModal(); // Close modal

        // Return to the currently active view or WOD
        const activeNavButton = document.querySelector('.nav-button.active');
        const returnViewName = activeNavButton ? activeNavButton.id.replace('nav-', '') : 'wod';
        
        if (returnViewName === 'wod') {
            // If returning to WOD, pass the current WOD date to maintain context
            showView('wod', APP_STATE.currentWODDate, activeNavButton); 
        } else {
            showView(returnViewName, null, activeNavButton); // Refresh current view
        }
    }
    
    function uncompleteWorkout(dateStr) {
        // Delete the log entry entirely to reset the status
        delete APP_STATE.loggedWorkouts[dateStr];
        localStorage.setItem('loggedWorkouts', JSON.stringify(APP_STATE.loggedWorkouts));
        
        closeCompleteModal(); // Close the modal immediately

        // Return to the currently active view
        const activeNavButton = document.querySelector('.nav-button.active');
        const returnViewName = activeNavButton ? activeNavButton.id.replace('nav-', '') : 'wod';
        
        if (returnViewName === 'wod') {
            // If returning to WOD, pass the current WOD date to maintain context
            showView('wod', APP_STATE.currentWODDate, activeNavButton); 
        } else {
            showView(returnViewName, null, activeNavButton); // Refresh current view
        }
    }


    // ---------------------------
    // Dynamic Modal Logic
    // ---------------------------

    /**
     * Toggles the modal view to show the link input field for editing/adding a Strava link.
     */
    function toggleEditStrava(dateStr, isEdit) {
        const loggedData = APP_STATE.loggedWorkouts[dateStr] || {};
        const stravaLink = loggedData.strava || '';
        const form = document.getElementById('complete-form');
        
        // Helper: Create the Strava Link input field
        const linkInputHTML = `<label class="block mb-4 text-left">
                  <span class="text-gray-700 font-medium">${isEdit ? 'Edit' : 'Add'} Strava Link:</span>
                  <input type="url" id="strava-link-input" placeholder="e.g., https://www.strava.com/activities/..."
                      class="mt-1 block w-full border border-gray-300 rounded-xl py-2 px-3 focus:ring-blue-500 focus:border-blue-500" value="${stravaLink}" />
              </label>`;
              
        form.innerHTML = `
            ${linkInputHTML}
            <div class="mt-4">
                <button type="submit" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-xl shadow flex items-center justify-center gap-2">
                    <i data-lucide="save"></i> Save Link
                </button>
            </div>
        `;

        // Ensure form submit still calls the main completeWorkout
        form.onsubmit = function(event) {
            event.preventDefault();
            completeWorkout(dateStr); 
        };
        lucide.createIcons();
    }


    /**
     * Shows the simplified completion modal with dynamic buttons based on status.
     * @param {string} dateStr - The date string for the workout.
     * @param {string} mode - Optional mode, if 'edit-strava' is passed, it jumps to the input screen.
     */
    function showCompleteModal(dateStr, mode = null) {
        const planActivity = APP_STATE.plan[dateStr]?.activity || "No Plan Activity";
        const loggedData = APP_STATE.loggedWorkouts[dateStr] || {};
        const isCompleted = !!loggedData.completed;
        const stravaLink = loggedData.strava || '';
        const form = document.getElementById('complete-form');
        
        // Set fixed modal header
        document.getElementById('complete-modal-title').textContent = planActivity;
        document.getElementById('complete-modal-message').innerHTML = `Planned activity for <strong>${formatDisplayDate(dateStr)} (${dateStr})</strong>.`;

        // NEW: Check for immediate edit mode (triggered by "Add Link" in WOD view)
        if (mode === 'edit-strava' && isCompleted) {
            toggleEditStrava(dateStr, !!stravaLink); // Pass existing link status
            document.getElementById('complete-modal').classList.remove('hidden');
            lucide.createIcons();
            return;
        }

        let formHTML = '';
        
        if (isCompleted) {
            // --- SCENARIO: WORKOUT IS COMPLETE ---
            if (stravaLink) {
                // Complete with Strava Link: View & Edit buttons
                formHTML = `
                    <div class="flex flex-col gap-3">
                        <a href="${stravaLink}" target="_blank"
                            class="flex justify-center items-center gap-2 w-full bg-orange-500 hover:bg-orange-500 text-white font-semibold py-3 rounded-xl shadow">
                            <i data-lucide="external-link"></i> View on Strava
                        </a>
                        
                        <button type="button" onclick="toggleEditStrava('${dateStr}', true)"
                            class="flex justify-center items-center gap-2 w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-xl shadow">
                            <i data-lucide="edit-3"></i> Edit Link
                        </button>
                    </div>
                `;
            } else {
                // Complete WITHOUT Strava Link: Add Link button
                formHTML = `
                    <div class="flex flex-col gap-3">
                        <p class="text-sm text-gray-500 italic">No Strava link added yet.</p>
                        <button type="button" onclick="toggleEditStrava('${dateStr}', false)"
                            class="flex justify-center items-center gap-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-xl shadow">
                            <i data-lucide="link"></i> Add Strava Link
                        </button>
                    </div>
                `;
            }
            // Add Unmark Complete button for both completed scenarios
            formHTML += `
                <button type="button" onclick="uncompleteWorkout('${dateStr}')"
                    class="flex justify-center items-center gap-2 w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-xl shadow mt-4">
                    <i data-lucide="x-circle" class="w-5 h-5"></i> Unmark Complete
                </button>
            `;
            
        } else {
            // --- SCENARIO: WORKOUT IS NOT COMPLETE ---
            
            // Helper: Create the Strava Link input field
            const linkInputHTML = `<label class="block mb-4 text-left">
                        <span class="text-gray-700 font-medium">Strava Link (Optional):</span>
                        <input type="url" id="strava-link-input" placeholder="e.g., https://www.strava.com/activities/..."
                            class="mt-1 block w-full border border-gray-300 rounded-xl py-2 px-3 focus:ring-blue-500 focus:border-blue-500" value="${stravaLink}" />
                    </label>`;

            // NEW: Hide 'Mark Complete' if activity is a rest day
            if (planActivity.toLowerCase().includes('rest day')) {
                formHTML = `
                    <p class="text-lg text-gray-600 mb-6 font-medium">Enjoy your well-deserved rest!</p>
                    <button type="button" onclick="closeCompleteModal()" 
                        class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 rounded-xl shadow flex items-center justify-center gap-2">
                        <i data-lucide="thumbs-up"></i> All good
                    </button>
                `;
            } else {
                formHTML = `
                    ${linkInputHTML}
                    <button type="submit" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-xl shadow flex items-center justify-center gap-2">
                        <i data-lucide="check"></i> Mark Complete
                    </button>
                `;
            }
        }
        
        // Render the content and set the submit handler
        form.innerHTML = formHTML;
        form.onsubmit = function(event) {
            event.preventDefault();
            completeWorkout(dateStr); 
        };

        document.getElementById('complete-modal').classList.remove('hidden');
        lucide.createIcons();
    }


    // ---------------------------
    // WOD (Workout of the Day) View
    // ---------------------------
    // ---------------------------
    // WOD (Workout of the Day) View
    // ---------------------------
    function renderWODView(dateStr = null) {
      // Use the provided date or the stored date, default to today
      const dateToDisplay = dateStr || APP_STATE.currentWODDate || formatDate(new Date());
      APP_STATE.currentWODDate = dateToDisplay;

      const dateObj = new Date(dateToDisplay);
      const todayStr = formatDate(new Date());
      
      const weekday = DAY_NAMES_FULL[dateObj.getDay()];

      const hasPlan = Object.keys(APP_STATE.plan).length > 0;
      const plannedWOD = APP_STATE.plan[dateToDisplay] || { activity: "Rest Day", week: "N/A" };
      const isLogged = APP_STATE.loggedWorkouts[dateToDisplay] && APP_STATE.loggedWorkouts[dateToDisplay].completed;
      const loggedLink = APP_STATE.loggedWorkouts[dateToDisplay]?.strava;

      let statusIconHtml = '';
      let action = ''; 
      let loggedDetailsInCenter = ''; 
      
      // Determine if the navigation buttons should be shown
      const diffInDays = Math.round((dateObj.getTime() - new Date(todayStr).getTime()) / (1000 * 60 * 60 * 24));
      
      const showPrevButton = true; // Always allow looking back
      const showNextButton = diffInDays < 7; // Only allow looking up to a week in advance

      // --- NEW: Back to Today Button ---
      const isToday = dateToDisplay === todayStr;
      let backToTodayButton = '';
      if (!isToday) {
           backToTodayButton = `
                <button onclick="showView('wod', '${todayStr}', document.getElementById('nav-wod'))" 
                    class="flex items-center gap-1 text-sm font-semibold text-blue-500 hover:text-blue-700 py-2 px-3 rounded-xl border border-blue-200 bg-blue-50/70">
                    <i data-lucide="calendar" class="w-4 h-4"></i> Back to Today
                </button>
           `;
      }
      
      // Combine day-to-day navigation and the new 'Back to Today' button
      const navButtons = `
        <div class="flex justify-between items-center w-full mt-4">
            <button onclick="showView('wod', formatDate(addDays(new Date(APP_STATE.currentWODDate), -1)))" 
                class="flex items-center gap-1 text-gray-500 hover:text-blue-600 font-semibold py-2 px-3 rounded-xl ${showPrevButton ? '' : 'invisible'}">
                <i data-lucide="arrow-left" class="w-5 h-5"></i> Yesterday
            </button>
            <button onclick="showView('wod', formatDate(addDays(new Date(APP_STATE.currentWODDate), 1)))" 
                class="flex items-center gap-1 text-gray-500 hover:text-blue-600 font-semibold py-2 px-3 rounded-xl ${showNextButton ? '' : 'invisible'}">
                Tomorrow <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
        </div>
      `;


      // Determine the Action block and Status Icon
      if (hasPlan) {
        
        if (isLogged) {
            // Plan Loaded & Completed: Checkmark/Completed
            statusIconHtml = `<i data-lucide="check-circle" class="w-8 h-8 text-green-500"></i>`;
            loggedDetailsInCenter = "Great work! Logged as complete.";
            
            // ACTION (Footer button/link area) 
            action = loggedLink ? `
                <a href="${loggedLink}" target="_blank"
                    class="flex justify-center items-center gap-2 w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 rounded-xl shadow-lg">
                    <i data-lucide="external-link"></i> View on Strava
                </a>
                <button onclick="showView('complete-wod', '${dateToDisplay}')" class="text-sm text-blue-500 hover:text-blue-700 mt-4 underline hover:no-underline">
                    Manage Completion
                </button>`
                : 
                `<button onclick="showView('complete-wod', '${dateToDisplay}', null, 'edit-strava')"
                    class="flex justify-center items-center gap-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-xl shadow-lg">
                    <i data-lucide="link"></i> Add Strava Link
                </button>
                <button onclick="showView('complete-wod', '${dateToDisplay}')" class="text-sm text-blue-500 hover:text-blue-700 mt-4 underline hover:no-underline">
                    Manage Completion
                </button>`;
            
        } else {
            // Plan Loaded & Not Completed: Activity/Run icon
            if (plannedWOD.activity.toLowerCase().includes('rest day')) {
                statusIconHtml = `<i data-lucide="bed" class="w-8 h-8 text-gray-500"></i>`;
                loggedDetailsInCenter = "Enjoy your well-deserved rest! 🧘‍♀️";
            } else {
                statusIconHtml = `<i data-lucide="activity" class="w-8 h-8 text-blue-600"></i>`;
                loggedDetailsInCenter = "Let’s crush it today 🏃‍♀️";
                // If not logged, the main action is Mark Complete
                action = `<button onclick="showView('complete-wod', '${dateToDisplay}')" class="flex justify-center items-center gap-2 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-xl shadow-lg">
                    <i data-lucide='check'></i> Mark Complete
                  </button>`; 
            }
        }
      } else {
        // No Plan: Warning Triangle
        statusIconHtml = `<i data-lucide="alert-triangle" class="w-8 h-8 text-orange-500"></i>`;
        loggedDetailsInCenter = "Import a plan to start training!";
        action = `<button onclick="showView('settings', null, document.getElementById('nav-settings'))" class="flex justify-center items-center gap-2 w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 rounded-xl shadow">
            <i data-lucide='upload'></i> Import Plan
        </button>`;
      }
      
      // Combine icon into the display span
      const statusIcon = `<span class="text-7xl">${statusIconHtml}</span>`;


      document.getElementById('app').innerHTML = `
        <div class="bg-white/90 backdrop-blur p-8 rounded-2xl shadow-xl text-center">
          <h2 class="text-3xl font-bold text-gray-900 mb-2 flex justify-center items-center gap-2">
            <i data-lucide="sun" class="w-6 h-6 text-orange-500"></i>${weekday}
          </h2>
          <p class="text-lg text-gray-500">${formatDisplayDate(dateToDisplay)} (${dateToDisplay})</p>
          <div class="border-t border-b border-gray-100 py-6 my-6">
            <p class="text-xl font-semibold text-blue-600 mb-2">${plannedWOD.week}</p>
            <div class="flex flex-col items-center space-y-2">
              ${statusIcon}
              <p class="text-3xl font-extrabold text-gray-900">${plannedWOD.activity}</p>
              <p class="text-sm text-gray-500 italic">${loggedDetailsInCenter}</p>
            </div>
          </div>
          <div class="mt-6 flex flex-col items-center space-y-4">
              ${action}
              ${backToTodayButton} ${navButtons}
          </div>
        </div>`;
    }

    // ---------------------------
    // Plan View Helpers & Logic 
    // ---------------------------
    function groupPlanByWeek() {
        const weeks = {};
        const sortedDates = Object.keys(APP_STATE.plan).sort();

        sortedDates.forEach(dateStr => {
            const planItem = APP_STATE.plan[dateStr];
            const date = new Date(dateStr);
            const dayOfWeek = DAY_NAMES_SHORT[date.getDay()]; 
            
            const weekKey = planItem.week || 'No Week';

            if (!weeks[weekKey]) {
                weeks[weekKey] = {
                    startDate: dateStr,
                    days: {}
                };
            }
            
            weeks[weekKey].days[dayOfWeek] = { 
                activity: planItem.activity, 
                date: dateStr,
                logged: APP_STATE.loggedWorkouts[dateStr] && APP_STATE.loggedWorkouts[dateStr].completed
            };
        });
        
        return weeks;
    }

    function renderPlanView() {
      const hasPlan = Object.keys(APP_STATE.plan).length > 0;
      let content = '';
      const todayStr = formatDate(new Date());

      if (!hasPlan) {
          content = `
              <p class="text-gray-600 mb-6">No plan loaded yet. Import one to see your schedule.</p>
              <button onclick="showView('settings', null, document.getElementById('nav-settings'))" class="bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-xl flex items-center gap-2 mx-auto">
                <i data-lucide="upload-cloud"></i> Import Plan
              </button>
          `;
      } else {
          const weeks = groupPlanByWeek();
          const progress = getPlanProgress();
          const headerDays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
          
          const tableRows = Object.keys(weeks).map((weekKey, index) => {
              const weekData = weeks[weekKey];
              let isCurrentWeek = (progress.currentWeek === (index + 1));
              
              const dayCells = headerDays.map(dayShort => {
                  const dayData = weekData.days[dayShort];
                  
                  if (!dayData) {
                      return `<td class="text-gray-400 italic">--</td>`;
                  }
                  
                  const isToday = dayData.date === todayStr;
                  const isCompleted = dayData.logged;
                  
                  let className = 'text-gray-700 hover:bg-gray-100';
                  if (isToday) {
                      className = 'font-bold bg-yellow-100 text-gray-900 border-2 border-yellow-400 rounded-lg shadow-sm hover:bg-yellow-200';
                  } else if (isCompleted) {
                      // Click opens the simplified complete modal to view/edit status
                      className = 'line-through text-green-600 bg-green-50/50 hover:bg-green-100/70';
                  } else if (dayData.activity.toLowerCase().includes('marathon day')) {
                      className = 'bg-red-500 text-white font-bold rounded-lg shadow-lg hover:bg-red-600';
                  }
                  
                  // Click opens the simplified complete modal for any day
                  return `<td class="${className}" onclick="showView('complete-wod', '${dayData.date}')" style="cursor: pointer;">
                      <div class="text-sm">${dayData.activity}</div>
                      <div class="text-xs text-gray-500 mt-1">${formatDisplayDate(dayData.date)}</div>
                      </td>`;
              }).join('');

              // Add class to the row if it's the current week for auto-scroll target
              const rowClassName = isCurrentWeek ? 'current-week-row' : '';

              return `
                  <tr class="${rowClassName}">
                      <td class="font-bold text-blue-600 whitespace-nowrap">${weekKey}</td>
                      ${dayCells}
                  </tr>
              `;
          }).join('');
          
          content = `
              <div class="p-4 bg-gray-50 rounded-xl mb-6 text-left shadow-inner">
                <p class="text-sm text-gray-700 mb-1">Plan started: <strong>${APP_STATE.startDate}</strong></p>
                <p class="text-sm text-gray-700 mb-1">Progress: <strong>${progress.completedWorkouts} / ${progress.totalWorkouts}</strong> Workouts Completed</p>
                <p class="text-sm text-gray-700">Current Week: <strong>Week ${progress.currentWeek || 'N/A'} of ${progress.totalWeeks}</strong></p>
              </div>

              <div id="plan-table-container" class="overflow-x-auto bg-white rounded-xl shadow-xl border border-gray-100 mb-6">
                <table class="min-w-full plan-table divide-y divide-gray-200">
                  <thead>
                    <tr>
                      <th class="left-0">Week</th>
                      <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${tableRows}
                  </tbody>
                </table>
              </div>
              <p class="text-sm text-gray-500 mb-4 mt-2"><strong>Tip:</strong> Click any day to manage its completion status or Strava link.</p>

              <div class="flex justify-between items-center gap-4 mt-6">
                <button onclick="clearPlan()" class="flex items-center gap-2 text-sm text-red-500 hover:text-red-700">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Clear Plan
                </button>
              </div>
          `;
      }

      document.getElementById('app').innerHTML = `
        <div class="bg-white/90 backdrop-blur p-8 rounded-2xl shadow-xl w-full">
          <h2 class="text-2xl font-bold mb-4 flex justify-center items-center gap-2">
            <i data-lucide="calendar-days" class="w-6 h-6 text-orange-500"></i> Training Plan
          </h2>
          ${content}
        </div>`;
        
        // --- Auto-Scroll to Current Week ---
        if (hasPlan) {
            const container = document.getElementById('plan-table-container');
            const currentWeekRow = container.querySelector('.current-week-row');
            if (currentWeekRow) {
                // Scroll container so the current week is visible
                const offset = currentWeekRow.offsetTop - container.offsetTop;
                container.scrollTop = offset - (container.clientHeight / 3); // Position near the top 1/3
            }
        }
    }

    // ---------------------------
    // Plan Import Logic 
    // ---------------------------
    function importPlan() {
      const fileInput = document.getElementById('plan-upload');
      const startDateInput = document.getElementById('start-date-input');
      const file = fileInput.files[0];
      const startDateStr = startDateInput.value;

      if (!file) {
        showModal('Error', 'Please select a CSV file to upload.');
        return;
      }
      if (!startDateStr) {
        showModal('Error', 'Please select a <strong>Start Date</strong> for your plan.');
        return;
      }
      if (!file.name.endsWith('.csv')) {
        showModal('Error', 'Invalid file type. Please upload a <strong>.csv</strong> file.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const csvText = event.target.result;
          const { newPlan, weekLabels } = parseCSV(csvText, startDateStr); // Now returns week labels too

          if (Object.keys(newPlan).length === 0) {
            showModal('Error', 'The file content is empty or could not be parsed. Ensure it follows the required format and the start date is correct.');
            return;
          }
          
          // --- Show Preview Modal Before Saving ---
          const totalDays = Object.keys(newPlan).length;
          const totalWeeks = weekLabels.length;
          const endDay = formatDate(addDays(new Date(startDateStr), totalDays - 1));
          
          const message = `
            <p class="mb-2"><strong>Training Plan Summary:</strong></p>
            <ul class="list-disc list-inside text-left mx-auto max-w-xs text-sm">
                <li>Total Weeks: <strong>${totalWeeks}</strong></li>
                <li>Total Workouts: <strong>${totalDays}</strong></li>
                <li>Plan Start: <strong>${startDateStr}</strong></li>
                <li>Plan End: <strong>${endDay}</strong></li>
            </ul>
            <p class="mt-4 font-medium text-gray-700">Do you want to save and activate this plan?</p>
          `;

          showModal('Confirm Plan Import', message, [
            {
              text: 'Save & Activate Plan',
              className: 'w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-xl shadow',
              handler: () => saveAndActivatePlan(newPlan, startDateStr)
            },
            {
              text: 'Cancel',
              className: 'w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 rounded-xl shadow',
              handler: closeModal
            }
          ]);


        } catch (e) {
          showModal('Error', 'Failed to process the CSV file. Please check its structure and the start date. Error: ' + e.message); 
          console.error('CSV processing error:', e);
        }
      };

      reader.onerror = function() {
        showModal('Error', 'Failed to read the file.');
      };

      reader.readAsText(file);
    }
    
    // New function to handle saving after confirmation
    function saveAndActivatePlan(newPlan, startDateStr) {
        APP_STATE.plan = newPlan;
        APP_STATE.startDate = startDateStr;
        localStorage.setItem('trainingPlan', JSON.stringify(newPlan));
        localStorage.setItem('planStartDate', startDateStr);
        APP_STATE.currentWODDate = formatDate(new Date()); // Reset WOD date to today

        closeModal(); // Close the confirmation modal
        showModal('Success! 🏃‍♀️', `Training plan imported successfully, starting <strong>${startDateStr}</strong>, with <strong>${Object.keys(newPlan).length}</strong> days planned.`);
        showView('wod', null, document.getElementById('nav-wod'));
    }

    function parseCSV(csv, startDateStr) {
      const plan = {};
      const weekLabels = [];
      const lines = csv.split('\n').filter(line => line.trim() !== '');
      if (lines.length < 2) return { newPlan: plan, weekLabels }; 

      // Header is ignored since we know the order is Week,Mon,Tue,Wed,Thu,Fri,Sat,Sun
      
      let currentDay = new Date(startDateStr);
      
      // Determine the day of the week the plan STARTS ON (0=Sun, 1=Mon... 6=Sat)
      const startDayOfWeekJS = currentDay.getDay(); 
      // Adjust JS's Sunday (0) to be last (7) so Mon=1, Sat=6, Sun=7
      const startDayIndex = startDayOfWeekJS === 0 ? 7 : startDayOfWeekJS;
      
      // The CSV data columns are Mon (index 1) to Sun (index 7).
      // We need to skip the first (startDayIndex - 1) activities of the first CSV week
      let daysToSkipInFirstRow = startDayIndex - 1;
      
      for (let i = 1; i < lines.length; i++) {
        // Simple split assuming no complex data in activity names
        const columns = lines[i].split(',').map(c => c.trim().replace(/^"|"$/g, ''));
        if (columns.length < 8) continue; 

        const weekLabel = columns[0];
        if (weekLabel) weekLabels.push(weekLabel); // Track week labels for summary

        // Process columns 1 through 7 (Mon through Sun)
        for (let j = 1; j < 8; j++) {
          
          // Correctly align the first activity with the start date.
          if (i === 1 && daysToSkipInFirstRow > 0) {
            daysToSkipInFirstRow--;
            // Advance the calendar day for the skipped activity
            currentDay = addDays(currentDay, 1); 
            continue;
          }
          
          const activity = columns[j];
          const dateStr = formatDate(currentDay);

          plan[dateStr] = { 
            activity: activity, 
            week: weekLabel 
          };
          
          // Move to the next calendar day
          currentDay = addDays(currentDay, 1);
        }
      }
      return { newPlan: plan, weekLabels };
    }
    
    // ---------------------------
    // Settings View (Plan Import/Clear Only)
    // ---------------------------
    function renderSettingsView() {
      // Set the default to today's date
      const today = formatDate(new Date()); 
      const progress = getPlanProgress();

      document.getElementById('app').innerHTML = `
        <div class="bg-white/90 backdrop-blur p-8 rounded-2xl shadow-xl text-center">
          <h2 class="text-2xl font-bold mb-6 flex justify-center items-center gap-2">
            <i data-lucide="settings" class="w-6 h-6 text-blue-600"></i> App Settings
          </h2>
          
          ${Object.keys(APP_STATE.plan).length > 0 ? `
            <div class="p-4 bg-gray-100 rounded-xl mb-6 text-left shadow-inner">
                <h3 class="text-lg font-bold text-gray-800 mb-2">Current Plan Status</h3>
                <p class="text-sm text-gray-700 mb-1">Total Workouts: <strong>${progress.totalWorkouts}</strong></p>
                <p class="text-sm text-gray-700 mb-1">Completed: <strong>${progress.completedWorkouts}</strong></p>
                <p class="text-sm text-gray-700">Current Week: <strong>${progress.currentWeek || 'N/A'} / ${progress.totalWeeks}</strong></p>
            </div>` : ''}


          <div class="p-6 border border-blue-200 rounded-xl bg-blue-50/50 mb-6 text-left">
            <h3 class="text-xl font-bold text-blue-800 mb-4 flex items-center gap-2">
                <i data-lucide="calendar-check" class="w-5 h-5"></i> Manage Training Plan
            </h3>
            <p class="text-sm text-gray-700 mb-4">
                Upload your marathon training plan CSV and choose a start date.
            </p>
            <p class="text-xs text-gray-500 mb-4 italic p-2 border border-gray-200 rounded-md">
                <strong>Required CSV Header</strong>: Week,Mon,Tue,Wed,Thu,Fri,Sat,Sun
            </p>

            <label for="start-date-input" class="block font-semibold text-gray-700">1. Plan Start Date 📅</label>
            <input type="date" id="start-date-input" value="${APP_STATE.startDate || today}"
              class="mt-1 border border-gray-300 rounded-xl py-2 px-4 w-full text-lg shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500" />
            
            <label for="plan-upload-container" class="block font-semibold text-gray-700 mt-4">2. Upload Plan CSV</label>
            <div class="file-input-container mt-1" id="plan-upload-container">
              <input type="file" accept=".csv" id="plan-upload" onchange="document.getElementById('file-name').textContent = this.files[0] ? this.files[0].name : 'Choose File (e.g., myplan.csv)'" />
              <label for="plan-upload" class="file-input-label">
                <i data-lucide="file-text" class="w-5 h-5"></i>
                <span id="file-name">${APP_STATE.plan && Object.keys(APP_STATE.plan).length > 0 ? 'Plan loaded' : 'Choose File (e.g., myplan.csv)'}</span>
              </label>
            </div>
            
            <button onclick="importPlan()" 
              class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-xl shadow flex items-center justify-center gap-2">
              <i data-lucide="chevrons-up"></i> Process & Import Plan
            </button>

            <div class="mt-6 pt-4 border-t border-gray-200">
                <button onclick="clearPlan()" 
                    class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-xl shadow flex items-center justify-center gap-2">
                    <i data-lucide="trash-2"></i> Clear Current Plan
                </button>
            </div>
          </div>
          
          </div>`;
    }

    // ---------------------------
    // Init
    // ---------------------------
    function init() {
      // Initialize with WOD (Workout of the Day) set to today's date
      const today = formatDate(new Date());
      APP_STATE.currentWODDate = today;
      showView('wod', today, document.getElementById('nav-wod'));
    }

    window.onload = function () {
      init();
      lucide.createIcons();
    };
  </script>

</body>
</html>
