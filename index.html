<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Marathon Coach</title>
    <link rel="icon" type="image/png" sizes="32x32" href="marathon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="marathon (1).png">
    <link rel="apple-touch-icon" href="Gemini_Generated_Image_utx4rzutx4rzutx4.png">
    <link rel="manifest" href="/site.webmanifest">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body {
      font-family: 'Inter', system-ui, sans-serif;
      /* Add padding to the bottom of the body to prevent content from being hidden by the fixed nav */
      padding-bottom: 5rem; /* Adjust based on nav height */
    }
    /* Custom styling for the file input */
    .file-input-container {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .file-input-label {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      height: 3rem;
      background-color: #f3f4f6; /* bg-gray-100 */
      color: #1f2937; /* text-gray-800 */
      border: 2px dashed #d1d5db; /* border-gray-300 */
      border-radius: 0.75rem; /* rounded-xl */
      transition: background-color 0.15s;
    }
    .file-input-label:hover {
      background-color: #e5e7eb; /* hover:bg-gray-200 */
    }
    #plan-upload {
      opacity: 0;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    /* Table styles for readability */
    .plan-table th, .plan-table td {
        padding: 0.5rem 0.75rem;
        text-align: left;
        border-bottom: 1px solid #f3f4f6; /* light gray */
        vertical-align: top;
        /* Ensure cells are clickable */
        cursor: pointer; 
    }
    .plan-table th {
        background-color: #f9fafb; /* bg-gray-50 */
        font-weight: 600;
        color: #1f2937; /* text-gray-900 */
    }
    .plan-table tr:hover {
        background-color: #f5f5f5;
    }
    /* Log View Styles - New fitness look */
    .log-card {
        border-left: 5px solid #ef4444; /* red-500 for activity focus */
        transition: transform 0.15s, box-shadow 0.15s;
    }
    .log-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    /* Bottom Navigation Bar Styles */
    #bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
    }
    .nav-button.active {
      color: #3b82f6; /* blue-500 */
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-orange-50 to-white min-h-screen flex flex-col">

  <header class="flex items-center justify-between px-6 py-4 bg-white/70 backdrop-blur-md shadow-md">
    <div class="flex items-center space-x-2">
      <i data-lucide="activity" class="w-6 h-6 text-orange-500"></i>
      <h1 class="text-2xl font-extrabold text-gray-900 tracking-tight">Marathon Coach</h1>
    </div>
  </header>

  <main id="app" class="flex-grow p-6 md:p-10 max-w-3xl mx-auto w-full"></main>

  <nav id="bottom-nav" class="bg-white/90 backdrop-blur shadow-2xl border-t border-gray-100">
    <div class="flex justify-around items-center h-20 max-w-3xl mx-auto">
      <button id="nav-dashboard" onclick="showView('dashboard', null, this)" class="nav-button flex flex-col items-center p-2 text-gray-500 hover:text-blue-600 active">
        <i data-lucide="home" class="w-6 h-6"></i>
        <span class="text-xs mt-1">Dashboard</span>
      </button>
      <button id="nav-plan" onclick="showView('plan', null, this)" class="nav-button flex flex-col items-center p-2 text-gray-500 hover:text-blue-600">
        <i data-lucide="calendar-days" class="w-6 h-6"></i>
        <span class="text-xs mt-1">Plan</span>
      </button>
      <button id="nav-log" onclick="showView('log', null, this)" class="nav-button flex flex-col items-center p-2 text-gray-500 hover:text-blue-600">
        <i data-lucide="list-checks" class="w-6 h-6"></i>
        <span class="text-xs mt-1">Log</span>
      </button>
      <button id="nav-import" onclick="showView('import', null, this)" class="nav-button flex flex-col items-center p-2 text-gray-500 hover:text-blue-600">
        <i data-lucide="upload" class="w-6 h-6"></i>
        <span class="text-xs mt-1">Import</span>
      </button>
    </div>
  </nav>

  <div id="message-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 w-11/12 max-w-md text-center shadow-xl border border-gray-100">
      <h2 id="modal-title" class="text-xl font-semibold mb-3 text-gray-900"></h2>
      <p id="modal-message" class="text-gray-600 mb-4"></p>
      <button id="modal-close-button" onclick="closeModal()"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-xl shadow transition-all duration-150">
        Close
      </button>
    </div>
  </div>

  <script>
    // ---------------------------
    // Global App State
    // ---------------------------
    const APP_STATE = {
      plan: JSON.parse(localStorage.getItem('trainingPlan') || '{}'),
      // NOTE: Added placeholder fields for demonstration purposes
      loggedWorkouts: JSON.parse(localStorage.getItem('loggedWorkouts') || '{}'),
      startDate: localStorage.getItem('planStartDate') || null
    };

    // ---------------------------
    // Helpers
    // ---------------------------
    const formatDate = d => new Date(d).toISOString().split('T')[0];
    const DAY_NAMES_SHORT = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    const DAY_NAMES_FULL = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

    // Function to convert total minutes to HH:MM:SS string
    function formatTime(totalMinutes) {
        if (totalMinutes <= 0 || isNaN(totalMinutes)) return '00:00:00';
        const totalSeconds = Math.round(totalMinutes * 60);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // Function to convert HH:MM:SS string to total minutes (float)
    function timeStringToMinutes(timeStr) {
        if (!timeStr) return 0;
        const parts = timeStr.split(':').map(Number);
        let hours = 0, minutes = 0, seconds = 0;

        if (parts.length === 3) {
            [hours, minutes, seconds] = parts;
        } else if (parts.length === 2) {
            // Assume MM:SS if no hours were entered
            [minutes, seconds] = parts;
        } else if (parts.length === 1) {
            // Assume SS if only one part
            [seconds] = parts;
        }

        // Convert everything to total minutes
        return hours * 60 + minutes + seconds / 60;
    }

    // Date utility to add days
    const addDays = (date, days) => {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    };
    
    // Helper to calculate Pace in mm:ss format
    function calculatePace(distanceKm, timeMinutes) {
        if (distanceKm <= 0 || timeMinutes <= 0) return 'N/A';
        const paceDecimal = timeMinutes / distanceKm; // e.g., 5.5 min/km
        const minutes = Math.floor(paceDecimal);
        const seconds = Math.round((paceDecimal - minutes) * 60);
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} /km`;
    }

    // Helper to clear the plan
    function clearPlan() {
        if (confirm("Are you sure you want to clear the entire training plan? This cannot be undone.")) {
            APP_STATE.plan = {};
            APP_STATE.startDate = null;
            localStorage.removeItem('trainingPlan');
            localStorage.removeItem('planStartDate');
            showModal('Plan Cleared', 'Your training plan has been removed.');
            showView('dashboard');
        }
    }

    // ---------------------------
    // Navigation & View Switcher
    // ---------------------------
    function setActiveNav(activeButton) {
        document.querySelectorAll('.nav-button').forEach(btn => {
            btn.classList.remove('active', 'text-blue-600');
            btn.classList.add('text-gray-500');
        });
        if (activeButton) {
            activeButton.classList.add('active', 'text-blue-600');
            activeButton.classList.remove('text-gray-500');
        }
    }

    function showView(view, date = null, navButton = null) {
      const app = document.getElementById('app');
      app.classList.add("opacity-0");
      
      // Handle setting active nav button
      if (navButton) {
        setActiveNav(navButton);
      } else if (view === 'dashboard' || view === 'plan' || view === 'log' || view === 'import') {
        setActiveNav(document.getElementById(`nav-${view}`));
      } else {
        // Clear active state for forms/sub-views
        setActiveNav(null);
      }


      setTimeout(() => {
        if (view === 'dashboard') renderDashboard();
        else if (view === 'plan') renderPlanView();
        else if (view === 'log') renderLogView();
        else if (view === 'log-detail') renderLogDetailView(date);
        else if (view === 'log-workout') renderLogWorkoutView(date);
        else if (view === 'import') renderImportView();
        app.classList.remove("opacity-0");
        lucide.createIcons(); // refresh icons
      }, 150);
    }

    // ---------------------------
    // Modal Helpers
    // ---------------------------
    function showModal(title, message) {
      document.getElementById('modal-title').textContent = title;
      // NOTE: Using innerHTML here because the message string now contains <strong> tags
      document.getElementById('modal-message').innerHTML = message;
      document.getElementById('message-modal').classList.remove('hidden');
    }

    function closeModal() {
      const modal = document.getElementById('message-modal');
      modal.classList.add('hidden');
      const closeButton = document.getElementById('modal-close-button');
      closeButton.textContent = "Close";
      closeButton.onclick = closeModal;
      const tempCancel = document.getElementById('modal-cancel-button');
      if (tempCancel) tempCancel.remove();
    }

    // ---------------------------
    // Dashboard (UPDATED with Lucide Icons)
    // ---------------------------
    function renderDashboard() {
      const today = new Date();
      const todayStr = formatDate(today);
      const weekday = DAY_NAMES_FULL[today.getDay()];

      const hasPlan = Object.keys(APP_STATE.plan).length > 0;

      let planDetails = { activity: "No Plan Loaded", week: "N/A" };
      let statusIconHtml = '';
      let action = `<button onclick="showView('import', null, document.getElementById('nav-import'))" class="flex justify-center items-center gap-2 w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 rounded-xl shadow">
          <i data-lucide='upload'></i> Import Plan
        </button>`;

      if (hasPlan) {
        planDetails = APP_STATE.plan[todayStr] || { activity: "Rest Day", week: "N/A" };
        const logged = APP_STATE.loggedWorkouts[todayStr];
        
        // Determine the Status Icon
        if (logged) {
            // Plan Loaded & Logged: Checkmark/Completed
            statusIconHtml = `<i data-lucide="check-circle" class="w-8 h-8 text-green-500"></i>`;
        }

        // Determine the action button
        action = logged ? 
          `<button onclick="showView('log-detail', '${todayStr}')" class="flex justify-center items-center gap-2 w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-xl shadow">
            <i data-lucide='eye'></i> View Log Details
          </button>`
          :
          `<button onclick="showView('log-workout', '${todayStr}')" class="flex justify-center items-center gap-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-xl shadow">
            <i data-lucide='edit-3'></i> Log Workout
          </button>`;
      } else {
        // No Plan: Warning Triangle
        statusIconHtml = `<i data-lucide="alert-triangle" class="w-8 h-8 text-orange-500"></i>`;
        // Action is already set to Import Plan
      }
      
      // Combine icon into the display span
      const statusIcon = `<span class="text-7xl">${statusIconHtml}</span>`;


      document.getElementById('app').innerHTML = `
        <div class="bg-white/90 backdrop-blur p-8 rounded-2xl shadow-xl text-center transition-all duration-300 hover:-translate-y-1">
          <h2 class="text-3xl font-bold text-gray-900 mb-2 flex justify-center items-center gap-2">
            <i data-lucide="sun" class="w-6 h-6 text-orange-500"></i>${weekday}
          </h2>
          <p class="text-lg text-gray-500">${todayStr}</p>
          <div class="border-t border-b border-gray-100 py-6 my-6">
            <p class="text-xl font-semibold text-blue-600 mb-2">${planDetails.week}</p>
            <div class="flex flex-col items-center space-y-2">
              ${statusIcon}
              <p class="text-3xl font-extrabold text-gray-900">${planDetails.activity}</p>
              <p class="text-sm text-gray-500 italic">${hasPlan ? "Let’s crush it today 💥" : "Import a plan to start training!"}</p>
            </div>
          </div>
          ${action}
        </div>`;
    }

    // ---------------------------
    // Log Workout Form View & Logic
    // ---------------------------
    function renderLogWorkoutView(dateStr) {
        // Ensures only this view is highlighted if accessed from dashboard/plan table
        setActiveNav(null); 
        
        const planActivity = APP_STATE.plan[dateStr]?.activity || "No Plan Activity";
        const loggedData = APP_STATE.loggedWorkouts[dateStr] || {};
        const loggedTimeStr = loggedData.time ? formatTime(loggedData.time) : ''; 
        const isEdit = Object.keys(loggedData).length > 0;
        
        const title = isEdit ? `Edit Log: ${dateStr}` : `   Log: ${dateStr}`;
        // UPDATED strong tags
        const plannedText = planActivity !== "Rest Day" ? `<p class="text-gray-600 text-sm mb-4">Planned: <strong>${planActivity}</strong></p>` : '';
        
        document.getElementById('app').innerHTML = `
            <div class="bg-white/90 backdrop-blur p-8 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold mb-2 flex justify-center items-center gap-2">
                    <i data-lucide="edit-3" class="w-6 h-6 text-blue-600"></i> ${title}
                </h2>
                ${plannedText}
                <form id="log-form" onsubmit="event.preventDefault(); logWorkout('${dateStr}');">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <label class="block">
                            <span class="text-gray-700">Distance:</span>
                            <input type="number" step="0.01" id="log-distance" value="${loggedData.distance || ''}"
                                class="mt-1 block w-full border border-gray-300 rounded-xl py-2 px-3 focus:ring-blue-500 focus:border-blue-500" placeholder="km"/>
                        </label>
                        <label class="block">
                            <span class="text-gray-700">Time:</span> <input type="text" id="log-time" value="${loggedTimeStr}" 
                                class="mt-1 block w-full border border-gray-300 rounded-xl py-2 px-3 focus:ring-blue-500 focus:border-blue-500" placeholder="HH:MM:SS" />
                        </label>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <label class="block">
                            <span class="text-gray-700">Avg BPM:</span>
                            <input type="number" step="1" id="log-hr" value="${loggedData.hr || ''}"
                                class="mt-1 block w-full border border-gray-300 rounded-xl py-2 px-3 focus:ring-blue-500 focus:border-blue-500" />
                        </label>
                        <label class="block">
                            <span class="text-gray-700">Strava Link:</span>
                            <input type="text" id="log-strava" value="${loggedData.strava || ''}"
                                class="mt-1 block w-full border border-gray-300 rounded-xl py-2 px-3 focus:ring-blue-500 focus:border-blue-500" placeholder="URL"/>
                        </label>
                    </div>

                    <label class="block mb-6">
                        <span class="text-gray-700">Notes:</span>
                        <textarea id="log-notes" rows="3"
                            class="mt-1 block w-full border border-gray-300 rounded-xl py-2 px-3 focus:ring-blue-500 focus:border-blue-500">${loggedData.notes || ''}</textarea>
                    </label>
                    
                    <div class="flex flex-col md:flex-row gap-4">
                        <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-xl shadow transition-all duration-150 flex items-center justify-center gap-2">
                            <i data-lucide="save"></i> ${isEdit ? 'Update Log' : 'Save Log'}
                        </button>
                        ${isEdit ? 
                            `<button type="button" onclick="deleteLog('${dateStr}')" class="md:w-auto bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-xl shadow transition-all duration-150 flex items-center justify-center gap-2">
                                <i data-lucide="trash-2"></i> Delete
                            </button>` : ''}
                    </div>
                    ${isEdit ? 
                        `<button type="button" onclick="showView('log-detail', '${dateStr}')" class="w-full mt-4 bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-semibold py-3 rounded-xl transition-all duration-150 flex items-center justify-center gap-2">
                            <i data-lucide="eye"></i> View
                        </button>` : ''}
                </form>
            </div>
        `;
    }

    /**
     * Saves the workout log data.
     */
    function logWorkout(dateStr) {
        const distance = document.getElementById('log-distance').value;
        const timeStr = document.getElementById('log-time').value;
        const hr = document.getElementById('log-hr').value;
        const strava = document.getElementById('log-strava').value;
        const notes = document.getElementById('log-notes').value;

        // New: Convert time string to minutes
        const time = timeStringToMinutes(timeStr); 

        if (!distance && !time && !notes) {
             showModal('Validation Error', 'Please enter at least a distance, time, or notes to save the log.');
             return;
        }

        APP_STATE.loggedWorkouts[dateStr] = {
            distance: distance ? parseFloat(distance) : 0,
            time: time,
            hr: hr ? parseInt(hr) : null,
            strava: strava.trim(),
            notes: notes.trim(),
            date: dateStr,
            plannedActivity: APP_STATE.plan[dateStr]?.activity || 'N/A'
        };

        localStorage.setItem('loggedWorkouts', JSON.stringify(APP_STATE.loggedWorkouts));
        // UPDATED strong tags
        showModal('Success!', `Workout log for <strong>${dateStr}</strong> saved.`);
        // After save, show the new detail view
        setTimeout(() => showView('log-detail', dateStr), 1000); 
    }
    
    /**
     * Deletes a workout log entry.
     */
    function deleteLog(dateStr) {
        if (confirm(`Are you sure you want to delete the log for ${dateStr}?`)) {
            delete APP_STATE.loggedWorkouts[dateStr];
            localStorage.setItem('loggedWorkouts', JSON.stringify(APP_STATE.loggedWorkouts));
            // UPDATED strong tags
            // After deleting, go to the general log view
            setTimeout(() => showView('log', null, document.getElementById('nav-log')), 700); 
        }
    }

    // ---------------------------
    // Log Detail View
    // ---------------------------
    function renderLogDetailView(dateStr) {
        setActiveNav(null); 
        const log = APP_STATE.loggedWorkouts[dateStr];
        
        if (!log) {
            // If the log doesn't exist, route to the log form instead
            showView('log-workout', dateStr);
            return;
        }

        const distance = log.distance;
        const time = log.time;
        const timeDisplay = formatTime(time);
        const hr = log.hr;
        const pace = calculatePace(distance, time);
        const stravaLink = log.strava;
        const planned = log.plannedActivity;

        const statCard = (icon, label, value, unit, colorClass = 'text-gray-900') => `
            <div class="flex flex-col items-center p-4 bg-gray-50 rounded-xl shadow-inner border border-gray-100">
                <i data-lucide="${icon}" class="w-6 h-6 text-blue-500 mb-1"></i>
                <div class="text-2xl font-extrabold ${colorClass}">${value}</div>
                <div class="text-sm text-gray-500 uppercase">${label} ${unit}</div>
            </div>
        `;
        
        const paceHtml = statCard('gauge', 'Pace', pace.split(' ')[0], pace.split(' ')[1] || '', 'text-orange-600');
        const hrHtml = statCard('heart-plus', 'Average', hr || 'N/A', 'BPM', hr ? 'text-red-500' : 'text-gray-400');
        
        const notesHtml = log.notes ? `
            <div class="bg-blue-50 p-4 rounded-xl shadow-md border border-blue-100 mt-6">
                <h4 class="font-bold text-blue-700 flex items-center gap-2"><i data-lucide="notebook-text" class="w-5 h-5"></i> Workout Notes</h4>
                <p class="text-gray-700 mt-2 whitespace-pre-wrap">${log.notes}</p>
            </div>
        ` : '';

        const stravaHtml = stravaLink ? `
            <a href="${stravaLink}" target="_blank" class="flex items-center justify-center gap-2 w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 rounded-xl shadow transition-all duration-150 mt-6">
                <i data-lucide="external-link" class="w-5 h-5"></i> View on Strava
            </a>
        ` : `
            <button onclick="showView('log-workout', '${dateStr}')" class="flex items-center justify-center gap-2 w-full bg-gray-300 text-gray-700 font-semibold py-3 rounded-xl transition-all duration-150 mt-6">
                <i data-lucide="link"></i> Add Strava Link
            </button>
        `;

        document.getElementById('app').innerHTML = `
            <div class="bg-white/90 backdrop-blur p-8 rounded-2xl shadow-2xl w-full">
                <h2 class="text-3xl font-bold mb-1 text-gray-900">${dateStr}</h2>
                <p class="text-lg text-gray-600 border-b pb-4 mb-6">Planned: <span class="font-semibold text-blue-600">${planned}</span></p>

                <div class="grid grid-cols-2 gap-4">
                    ${statCard('map-pin-house', 'Distance', distance.toFixed(1), 'km', 'text-green-600')}
                    ${statCard('clock', 'Duration', timeDisplay, '', 'text-indigo-600')}
                    ${paceHtml}
                    ${hrHtml}
                </div>

                ${notesHtml}

                <div class="flex flex-col gap-4 mt-8">
                    ${stravaHtml}
                    <button onclick="showView('log-workout', '${dateStr}')" class="flex items-center justify-center gap-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-xl shadow-lg transition-all duration-150">
                        <i data-lucide="edit-3"></i> Edit Log Data
                    </button>
                </div>
            </div>
        `;
    }


    // ---------------------------
    // Log View 
    // ---------------------------
    function renderLogView() {
        const logs = APP_STATE.loggedWorkouts;
        // Sort logs by date descending (newest first)
        const logDates = Object.keys(logs).sort().reverse(); 
        const todayStr = formatDate(new Date());
        
        let logContent = '';

        if (logDates.length === 0) {
            logContent = `
                <p class="text-gray-600 mb-6">You haven't logged any workouts yet.</p>
                <button onclick="showView('log-workout', '${todayStr}')" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-xl flex items-center gap-2 mx-auto">
                    <i data-lucide="edit-3"></i> Log Today's Workout
                </button>
            `;
        } else {
            const listItems = logDates.map(dateStr => {
                const log = logs[dateStr];
                const planned = log.plannedActivity;
                const distance = log.distance;
                const time = log.time;
                const timeDisplay = formatTime(time);

                // Determine the icon and color based on logged data
                let progressIcon = '<i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>';
                if (distance == 0 && time == 0 && log.notes === '') {
                    progressIcon = '<i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-500"></i>';
                } else if (planned.toLowerCase().includes('rest') && (distance > 0 || time > 0)) {
                     progressIcon = '<i data-lucide="zap" class="w-5 h-5 text-red-500"></i>'; // Did a workout on a rest day
                }

                return `
                    <div class="log-card bg-white p-5 rounded-xl shadow-lg mb-4 cursor-pointer" onclick="showView('log-detail', '${dateStr}')">
                        <div class="flex justify-between items-center mb-3 border-b border-gray-100 pb-2">
                            <h3 class="text-xl font-bold text-gray-900">${dateStr}</h3>
                            <div class="flex items-center gap-3">
                                ${progressIcon}
                                <button class="text-blue-500 hover:text-blue-700 flex items-center gap-1 text-sm">
                                    <i data-lucide="eye" class="w-4 h-4"></i> View
                                </button>
                            </div>
                        </div>
                        
                        <p class="text-sm text-gray-500 mb-3">
                            <strong>Planned:</strong> <span class="text-gray-700 font-medium">${planned}</span>
                        </p>

                        <div class="flex justify-around bg-gray-50 p-3 rounded-lg border border-gray-100">
                            <div class="text-center">
                                <span class="text-2xl font-extrabold text-orange-600">${distance.toFixed(1)}</span>
                                <span class="text-sm text-orange-600"> km</span>
                                <div class="text-xs text-gray-500 uppercase mt-1">Distance</div>
                            </div>
                            <div class="w-px bg-gray-200 mx-2"></div>
                            <div class="text-center">
                                <span class="text-2xl font-extrabold text-orange-600">${timeDisplay.substring(0, 5)}</span>
                                <div class="text-xs text-gray-500 uppercase mt-1">Duration</div>
                            </div>
                        </div>

                        ${log.notes ? `<p class="text-sm text-gray-600 mt-3 p-2 bg-blue-50 rounded-md border border-blue-100">
                            <span class="font-semibold text-blue-700">Notes:</span> ${log.notes}</p>` : ''}
                    </div>
                `;
            }).join('');

            logContent = `<div class="text-left max-h-[70vh] overflow-y-auto pr-2">${listItems}</div>`;
        }

        document.getElementById('app').innerHTML = `
            <div class="bg-white/90 backdrop-blur p-8 rounded-2xl shadow-xl w-full text-center">
                <h2 class="text-2xl font-bold mb-6 flex justify-center items-center gap-2 text-gray-900">
                    <i data-lucide="list-checks" class="w-6 h-6 text-orange-500"></i> Workout Log
                </h2>
                ${logContent}
            </div>
        `;
    }

    // ---------------------------
    // Plan View Helpers & Logic 
    // ---------------------------
    function groupPlanByWeek() {
        const weeks = {};
        const sortedDates = Object.keys(APP_STATE.plan).sort();

        sortedDates.forEach(dateStr => {
            const planItem = APP_STATE.plan[dateStr];
            const date = new Date(dateStr);
            const dayOfWeek = DAY_NAMES_SHORT[date.getDay()]; 
            
            const weekKey = planItem.week || 'No Week';

            if (!weeks[weekKey]) {
                weeks[weekKey] = {
                    startDate: dateStr,
                    days: {}
                };
            }
            
            weeks[weekKey].days[dayOfWeek] = { 
                activity: planItem.activity, 
                date: dateStr,
                logged: APP_STATE.loggedWorkouts[dateStr] ? true : false
            };
        });
        
        return weeks;
    }

    function renderPlanView() {
      const hasPlan = Object.keys(APP_STATE.plan).length > 0;
      let content = '';

      if (!hasPlan) {
          content = `
              <p class="text-gray-600 mb-6">No plan loaded yet. Import one to see your schedule.</p>
              <button onclick="showView('import', null, document.getElementById('nav-import'))" class="bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-xl flex items-center gap-2 mx-auto">
                <i data-lucide="upload-cloud"></i> Import Plan
              </button>
          `;
      } else {
          const weeks = groupPlanByWeek();
          const todayStr = formatDate(new Date());
          const headerDays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
          const tableRows = Object.keys(weeks).map(weekKey => {
              const weekData = weeks[weekKey];
              const dayCells = headerDays.map(dayShort => {
                  const dayData = weekData.days[dayShort];
                  
                  if (!dayData) {
                      return `<td class="text-gray-400 italic">--</td>`;
                  }
                  
                  const isToday = dayData.date === todayStr;
                  const isLogged = dayData.logged;
                  
                  let className = 'text-gray-700 hover:bg-gray-100 transition-colors';
                  if (isToday) {
                      className = 'font-bold bg-yellow-100 text-gray-900 border-2 border-yellow-400 rounded-lg shadow-sm hover:bg-yellow-200 transition-colors';
                  } else if (isLogged) {
                      // Click opens Log Detail View if already logged
                      className = 'line-through text-green-600 bg-green-50/50 hover:bg-green-100/70 transition-colors';
                  } else if (dayData.activity.toLowerCase().includes('marathon day')) {
                      className = 'bg-red-500 text-white font-bold rounded-lg shadow-lg hover:bg-red-600 transition-colors';
                  }
                  
                  // **Click opens the Log Workout Form directly for any day**
                  return `<td class="${className}" onclick="showView('log-workout', '${dayData.date}')" style="cursor: pointer;">
                      <div class="text-sm">${dayData.activity}</div>
                      <div class="text-xs text-gray-500 mt-1">${dayData.date.substring(5)}</div>
                      </td>`;
              }).join('');

              return `
                  <tr>
                      <td class="font-bold text-blue-600 whitespace-nowrap">${weekKey}</td>
                      ${dayCells}
                  </tr>
              `;
          }).join('');
          
          content = `
              <p class="text-lg text-gray-700 mb-6">Plan started on <strong>${APP_STATE.startDate}</strong>.</p>

              <div class="overflow-x-auto bg-white rounded-xl shadow-xl border border-gray-100 mb-6">
                <table class="min-w-full plan-table divide-y divide-gray-200">
                  <thead>
                    <tr>
                      <th class="left-0">Week</th>
                      <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${tableRows}
                  </tbody>
                </table>
              </div>
              <p class="text-sm text-gray-500 mb-4 mt-2"><strong>Tip:</strong> Click any day to log or edit your workout details.</p>

              <div class="flex justify-between items-center gap-4 mt-6">
                <button onclick="clearPlan()" class="flex items-center gap-2 text-sm text-red-500 hover:text-red-700">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Clear Plan
                </button>
                <button onclick="showView('dashboard', null, document.getElementById('nav-dashboard'))" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-xl flex items-center gap-2">
                  <i data-lucide="arrow-left"></i> Back to Dashboard
                </button>
              </div>
          `;
      }

      document.getElementById('app').innerHTML = `
        <div class="bg-white/90 backdrop-blur p-8 rounded-2xl shadow-xl w-full">
          <h2 class="text-2xl font-bold mb-4 flex justify-center items-center gap-2">
            <i data-lucide="calendar-days" class="w-6 h-6 text-orange-500"></i> Training Plan
          </h2>
          ${content}
        </div>`;
    }

    // ---------------------------
    // CSV Import Logic 
    // ---------------------------
    function importPlan() {
      const fileInput = document.getElementById('plan-upload');
      const startDateInput = document.getElementById('start-date-input');
      const file = fileInput.files[0];
      const startDateStr = startDateInput.value;

      if (!file) {
        showModal('Error', 'Please select a CSV file to upload.');
        return;
      }
      if (!startDateStr) {
        // UPDATED strong tags
        showModal('Error', 'Please select a <strong>Start Date</strong> for your plan.');
        return;
      }
      if (!file.name.endsWith('.csv')) {
        // UPDATED strong tags
        showModal('Error', 'Invalid file type. Please upload a <strong>.csv</strong> file.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const csvText = event.target.result;
          const newPlan = parseCSV(csvText, startDateStr);

          if (Object.keys(newPlan).length === 0) {
            showModal('Error', 'The file content is empty or could not be parsed. Ensure it follows the required format and the start date is correct.');
            return;
          }

          APP_STATE.plan = newPlan;
          APP_STATE.startDate = startDateStr;
          localStorage.setItem('trainingPlan', JSON.stringify(newPlan));
          localStorage.setItem('planStartDate', startDateStr);

          // UPDATED strong tags
          showModal('Success! 🎉', `Training plan imported successfully, starting <strong>${startDateStr}</strong>, with <strong>${Object.keys(newPlan).length}</strong> days planned.`);
          setTimeout(() => showView('dashboard', null, document.getElementById('nav-dashboard')), 1500);

        } catch (e) {
          showModal('Error', 'Failed to process the CSV file. Please check its structure and the start date.');
          console.error('CSV processing error:', e);
        }
      };

      reader.onerror = function() {
        showModal('Error', 'Failed to read the file.');
      };

      reader.readAsText(file);
    }

    function parseCSV(csv, startDateStr) {
      const plan = {};
      const lines = csv.split('\n').filter(line => line.trim() !== '');
      if (lines.length < 2) return plan; 

      // Header is ignored since we know the order is Week,Mon,Tue,Wed,Thu,Fri,Sat,Sun
      
      let currentDay = new Date(startDateStr);
      
      // Determine the day of the week the plan STARTS ON (0=Sun, 1=Mon... 6=Sat)
      const startDayOfWeekJS = currentDay.getDay(); 
      // Adjust JS's Sunday (0) to be last (7) so Mon=1, Sat=6, Sun=7
      const startDayIndex = startDayOfWeekJS === 0 ? 7 : startDayOfWeekJS;
      
      // The CSV data columns are Mon (index 1) to Sun (index 7).
      // We need to skip the first (startDayIndex - 1) activities of the first CSV week
      // to align the first activity with the given start date.
      let daysToSkipInFirstRow = startDayIndex - 1;
      
      for (let i = 1; i < lines.length; i++) {
        const columns = lines[i].split(',').map(c => c.trim());
        if (columns.length < 8) continue; 

        const weekLabel = columns[0];

        // Process columns 1 through 7 (Mon through Sun)
        for (let j = 1; j < 8; j++) {
          
          // Only skip activities in the first data row (i=1) if the skip count is > 0
          if (i === 1 && daysToSkipInFirstRow > 0) {
            daysToSkipInFirstRow--;
            continue;
          }
          
          const activity = columns[j];
          const dateStr = formatDate(currentDay);

          plan[dateStr] = { 
            activity: activity, 
            week: weekLabel 
          };
          
          // Move to the next calendar day
          currentDay = addDays(currentDay, 1);
        }
      }
      return plan;
    }


    // ---------------------------
    // Import Plan View
    // ---------------------------
    function renderImportView() {
      // Set the default to today's date
      const today = formatDate(new Date()); 

      document.getElementById('app').innerHTML = `
        <div class="bg-white/90 backdrop-blur p-8 rounded-2xl shadow-xl text-center">
          <h2 class="text-2xl font-bold mb-4 flex justify-center items-center gap-2">
            <i data-lucide="upload-cloud" class="w-6 h-6 text-blue-600"></i> Import Training Plan
          </h2>
          <p class="text-gray-600 mb-4">Upload your marathon training plan CSV and choose a start date.</p>
          
          <p class="text-sm text-gray-500 mb-6 italic border p-3 rounded-lg text-left">
            <strong>Required CSV Header</strong>: Week,Mon,Tue,Wed,Thu,Fri,Sat,Sun<br>
            *Example Data Row*: Week 1,Rest,4 km easy,Strength,4×3 min run / 2 min walk,Rest,5 km long run,Cross-train...
          </p>

          <div class="flex flex-col gap-4 mb-6">
            <label for="start-date-input" class="text-left font-semibold text-gray-700">1. Plan Start Date 🗓️</label>
            <input type="date" id="start-date-input" value="${APP_STATE.startDate || today}"
              class="border border-gray-300 rounded-xl py-2 px-4 w-full text-lg shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500" />
            
            <label for="plan-upload-container" class="text-left font-semibold text-gray-700 mt-4">2. Upload CSV File</label>
            <div class="file-input-container" id="plan-upload-container">
              <input type="file" accept=".csv" id="plan-upload" onchange="document.getElementById('file-name').textContent = this.files[0] ? this.files[0].name : 'No file chosen'" />
              <label for="plan-upload" class="file-input-label">
                <i data-lucide="file-text" class="w-5 h-5"></i>
                <span id="file-name">Choose File (e.g., myplan.csv)</span>
              </label>
            </div>
          </div>
          
          <div class="flex flex-col md:flex-row gap-4">
            <button onclick="importPlan()" 
              class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-xl shadow transition-all duration-150 flex items-center justify-center gap-2">
              <i data-lucide="chevrons-up"></i> Process & Import
            </button>
            <button onclick="showView('dashboard', null, document.getElementById('nav-dashboard'))" 
              class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-3 rounded-xl transition-all duration-150 flex items-center justify-center gap-2">
              <i data-lucide="x"></i> Cancel
            </button>
          </div>
        </div>`;
    }

    // ---------------------------
    // Init
    // ---------------------------
    function init() {
      // Initialize with dashboard and set the active nav button
      showView('dashboard', null, document.getElementById('nav-dashboard'));
    }

    window.onload = function () {
      init();
      lucide.createIcons();
    };
  </script>

</body>
</html>
